---
title: "Core microbiota investigation"
author: "Nejc Stopnisek, Ashley Shade"
date: "6/7/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(reshape2)
library(vegan)
library(here)

theme_set(theme_light())
```

## Determining core microbiota

This is the script used in the review manuscript (_Shade and Stopnisek_). 
To determine the core microbita from OTU dataset we first determine __occupancy and abundance__ of each OTU, next __rank the OTUs__, and finally, setting threshold based on the __Elbow method__.

### Occupancy-abundance 

Using provided zOTU table from Bowsher et al. [(2019)](https://www.biorxiv.org/content/10.1101/652883v1?rss=1) and rarefying it to 10000 reads per sample (nReads): 
```{r, error=F}
otu <- readRDS('~/Documents/git/PAPER_Shade_CurrOpinMicro/data/otuTable.rds')
nReads = 10000

otu_PA <- 1*((otu>0)==1)                                               # presence-absence data
otu_occ <- rowSums(otu_PA)/ncol(otu_PA)                                # occupancy calculation
otu_rel <- apply(decostand(otu, method="total", MARGIN=2),1, mean)     # relative abundance  
occ_abun <- add_rownames(as.data.frame(cbind(otu_occ, otu_rel)),'otu') # combining occupancy and abundance calculations into df
```

### OTU ranking based on their ccupancy-abundace characteristics

```{r, echo=TRUE}

otu_ranked <- occ_abun %>%
  #left_join(PresenceSum, by='otu') %>%
  transmute(otu=otu,
            rank=(otu_rel) + (otu_occ)) %>%
  arrange(desc(rank))
```

### Bray-Curtis distance calculation 

```{r, echo=TRUE}

BCaddition <- NULL

for(i in otu_ranked$otu){
  otu_start=otu_ranked$otu[1]
  start_matrix <- as.matrix(otu[otu_start,])
  start_matrix <- t(start_matrix)
  x <- apply(combn(ncol(start_matrix), 2), 2, function(x) sum(abs(start_matrix[,x[1]]- start_matrix[,x[2]]))/(2*nReads))
  x_names <- apply(combn(ncol(start_matrix), 2), 2, function(x) paste(colnames(start_matrix)[x], collapse=' - '))
  df_s <- data.frame(x_names,x)
  names(df_s)[2] <- 1 
  BCaddition <- rbind(BCaddition,df_s)

  for(i in 2:length(otu_ranked$otu)){
    otu_add=otu_ranked$otu[i]
    add_matrix <- as.matrix(otu[otu_add,])
    add_matrix <- t(add_matrix)
    start_matrix <- rbind(start_matrix, add_matrix)
    x <- apply(combn(ncol(start_matrix), 2), 2, function(x) sum(abs(start_matrix[,x[1]]-start_matrix[,x[2]]))/(2*nReads))
    x_names <- apply(combn(ncol(start_matrix), 2), 2, function(x) paste(colnames(start_matrix)[x], collapse=' - '))
    df_a <- data.frame(x_names,x)
    names(df_a)[2] <- i 
    BCaddition <- left_join(BCaddition, df_a, by=c('x_names'))
  }
} 

```

#### Occupancy - abundance plot

```{r, echo=F}
ggplot(occ_abun, aes(x=log10(otu_rel), y=otu_occ)) +
  geom_point(pch=21)+
  labs(x="log10(mean relative abundance)", y="Occupancy")

```


